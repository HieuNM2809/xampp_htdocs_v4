D∆∞·ªõi ƒë√¢y l√† h∆∞·ªõng d·∫´n t·ª´ng b∆∞·ªõc r·∫•t r√µ r√†ng ƒë·ªÉ b·∫°n c√≥ th·ªÉ **t·ª± m√¥ ph·ªèng** c√°ch `LOCK FOR UPDATE` ho·∫°t ƒë·ªông trong MySQL m·ªôt c√°ch th·ª±c t·∫ø v√† chi ti·∫øt:

---

## ‚úÖ **B∆∞·ªõc 1: Chu·∫©n b·ªã m√¥i tr∆∞·ªùng test**

### **1.1. T·∫°o database v√† b·∫£ng**

```sql
-- T·∫°o database demo
CREATE DATABASE lock_demo;
USE lock_demo;

-- T·∫°o b·∫£ng accounts
CREATE TABLE accounts (
  id INT PRIMARY KEY AUTO_INCREMENT,
  username VARCHAR(50) UNIQUE,
  balance INT
);
```

### **1.2. Th√™m d·ªØ li·ªáu m·∫´u**

```sql
INSERT INTO accounts (username, balance)
VALUES
  ('userA', 1000),
  ('userB', 500);
```

---

## ‚úÖ **B∆∞·ªõc 2: M√¥ ph·ªèng LOCK FOR UPDATE chi ti·∫øt**

B·∫°n c·∫ßn m·ªü **2 c·ª≠a s·ªï terminal** (ho·∫∑c 2 tab query trong phpMyAdmin, MySQL Workbench...) ƒë·ªÉ m√¥ ph·ªèng 2 giao d·ªãch ch·∫°y song song.

**Minh ho·∫° d·ªÖ hi·ªÉu:**

| Giao d·ªãch th·ª© nh·∫•t  | Giao d·ªãch th·ª© hai |
|---------------------|-------------------|
| Transaction 1       | Transaction 2     |

---

## üü¢ **B∆∞·ªõc 3: Th·ª±c hi·ªán Transaction 1**

**T·∫°i c·ª≠a s·ªï th·ª© nh·∫•t**, b·∫°n th·ª±c hi·ªán:

```sql
USE lock_demo;

START TRANSACTION;

-- Kh√≥a d√≤ng userA
SELECT * FROM accounts WHERE username = 'userA' FOR UPDATE;
```

- **L√∫c n√†y**: D√≤ng d·ªØ li·ªáu userA ƒë√£ ƒë∆∞·ª£c kh√≥a l·∫°i b·ªüi Transaction 1.

**L∆∞u √Ω**: ƒê·ª´ng COMMIT v·ªôi, c·ª© gi·ªØ nguy√™n tr·∫°ng th√°i n√†y.

---

## üî¥ **B∆∞·ªõc 4: Th·ª±c hi·ªán Transaction 2**

**T·∫°i c·ª≠a s·ªï th·ª© hai**, b·∫°n th·ª±c hi·ªán:

```sql
USE lock_demo;

START TRANSACTION;

-- C·ªë g·∫Øng truy c·∫≠p kh√≥a v√†o d√≤ng userA ƒëang b·ªã Transaction 1 gi·ªØ kh√≥a
SELECT * FROM accounts WHERE username = 'userA' FOR UPDATE;
```

- **K·∫øt qu·∫£**: B·∫°n s·∫Ω th·∫•y c√¢u l·ªánh b·ªã treo (waiting). V√¨ d√≤ng d·ªØ li·ªáu `userA` ƒëang b·ªã Transaction 1 gi·ªØ kh√≥a.

---

## üü¢ **B∆∞·ªõc 5: Tr·ªü l·∫°i Transaction 1 ƒë·ªÉ ho√†n t·∫•t giao d·ªãch**

·ªû **c·ª≠a s·ªï th·ª© nh·∫•t**, ti·∫øp t·ª•c:

```sql
-- Gi·∫£ s·ª≠ c·∫≠p nh·∫≠t s·ªë d∆∞ userA:
UPDATE accounts SET balance = balance - 200 WHERE username = 'userA';

-- C·∫≠p nh·∫≠t s·ªë d∆∞ userB:
UPDATE accounts SET balance = balance + 200 WHERE username = 'userB';

-- Ho√†n t·∫•t giao d·ªãch
COMMIT;
```

- Khi b·∫°n **COMMIT**, Transaction 1 k·∫øt th√∫c v√† gi·∫£i ph√≥ng kh√≥a c·ªßa userA.

---

## üî¥ **B∆∞·ªõc 6: Quan s√°t l·∫°i Transaction 2 sau khi Transaction 1 COMMIT**

Ngay l·∫≠p t·ª©c, **c·ª≠a s·ªï th·ª© hai (Transaction 2)**, ƒëang ƒë·ª©ng y√™n ·ªü l·ªánh SELECT tr∆∞·ªõc ƒë√≥, s·∫Ω ti·∫øp t·ª•c ch·∫°y v√¨ kh√≥a ƒë√£ ƒë∆∞·ª£c gi·∫£i ph√≥ng:

```sql
-- B√¢y gi·ªù Transaction 2 ti·∫øp t·ª•c ch·∫°y, v√≠ d·ª•:
UPDATE accounts SET balance = balance - 100 WHERE username = 'userA';

COMMIT;
```

- Transaction 2 th·ª±c hi·ªán xong, kh√≥a d√≤ng userA l·∫°i v√† gi·∫£i ph√≥ng ngay l·∫≠p t·ª©c sau khi commit.

---

## ‚úÖ **B∆∞·ªõc 7: Ki·ªÉm tra k·∫øt qu·∫£ cu·ªëi c√πng**

B·∫°n m·ªü l·∫°i c·ª≠a s·ªï truy v·∫•n b·∫•t k·ª≥ v√† ki·ªÉm tra b·∫£ng `accounts` ƒë·ªÉ th·∫•y k·∫øt qu·∫£ cu·ªëi c√πng:

```sql
SELECT * FROM accounts;
```

K·∫øt qu·∫£ cu·ªëi c√πng (sau c·∫£ 2 giao d·ªãch ho√†n t·∫•t):

| id | username | balance |
|----|----------|---------|
| 1  | userA    | 700     | (1000 - 200 - 100) |
| 2  | userB    | 700     | (500 + 200) |

---

## üö© **T√¨nh hu·ªëng Deadlock (n√¢ng cao - t√πy ch·ªçn)**

N·∫øu mu·ªën m√¥ ph·ªèng c·∫£ tr∆∞·ªùng h·ª£p deadlock, b·∫°n c√≥ th·ªÉ:

- Transaction 1: Lock userA, sau ƒë√≥ lock userB.
- Transaction 2: Lock userB tr∆∞·ªõc, r·ªìi lock userA.

L√∫c n√†y MySQL s·∫Ω ph√°t hi·ªán Deadlock v√† tr·∫£ v·ªÅ l·ªói:

```
ERROR 1213 (40001): Deadlock found when trying to get lock; try restarting transaction
```

---

## üö® **C√°c l∆∞u √Ω trong qu√° tr√¨nh m√¥ ph·ªèng:**

- B·∫°n ph·∫£i d√πng 2 c·ª≠a s·ªï ho·∫∑c 2 client query kh√°c nhau.
- Transaction th·ª© hai s·∫Ω b·ªã treo (ch·ªù kh√≥a) cho ƒë·∫øn khi transaction ƒë·∫ßu ti√™n commit ho·∫∑c rollback.
- N·∫øu mu·ªën k·∫øt th√∫c m·ªôt transaction ƒëang treo, b·∫°n c√≥ th·ªÉ ·∫•n `Ctrl + C` (tr√™n terminal), ho·∫∑c ng·∫Øt k·∫øt n·ªëi client.

---

**V·ªõi c√°c b∆∞·ªõc m√¥ ph·ªèng c·ª• th·ªÉ tr√™n, b·∫°n s·∫Ω hi·ªÉu r√µ c√°ch `LOCK FOR UPDATE` ho·∫°t ƒë·ªông th·ª±c t·∫ø trong MySQL m·ªôt c√°ch chi ti·∫øt nh·∫•t!**